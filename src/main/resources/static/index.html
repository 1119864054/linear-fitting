<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="">

    <title>Linear</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
          integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="dist/css/signin.css">
</head>

<body style="padding-bottom: 0;">
<div class="container">
    <div class="row">
        <div class="col-sm-8 blog-main">
            <div class="d-flex justify-content-between flex-wrap
                        flex-md-nowrap align-items-center pt-3 pb-2 mb-3
                        border-bottom">
                <h1 class="h2">线性回归分析</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group mr-2" id="uploadForm">
                        <!--                        <button type="button" class="btn btn-sm-->
                        <!--                                    btn-outline-primary">-->
                        <!--                        </button>-->
                        <input id="file" type="file" accept=".txt, .csv, .xls, .xlsx"/>
                        <button id="upload" type="button">解析文件</button>
                    </div>
                </div>
            </div>
            <div style="height: 50vh;width: 100%;" id="main"></div>
            <h2>数据</h2>
            <form>
                <div class="form-group">
                    <label for="data-area" id="data-fx"></label>
                    <textarea class="form-control" id="data-area" rows="3"></textarea>
                </div>
                <button type="button" class="btn btn-outline-dark" id="linear">数据分析</button>
                <button type="button" class="btn btn-outline-dark" id="linear-back">数据分析(后端)</button>
            </form>
        </div>

        <div class="col-sm-3 col-sm-offset-1 blog-sidebar">
            <div class="sidebar-module sidebar-module-inset" id="login_box">
                <div class="form-signin">
                    <ul class="nav">
                        <li class="nav-item">
                            <a class="nav-link disabled" href="#" id="login_tab"><h1 class="h3 mb-3 font-weight-normal"
                                                                                     aria-disabled="true">登录</h1></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="#" tabindex="-1" aria-disabled="true" id="reg_tab"><h1
                                    class="h3 mb-3 font-weight-normal">注册</h1></a>
                        </li>
                    </ul>
                    <block id="login_form" style="display: block">
                        <label for="loginUsername" class="sr-only">Username
                            address</label>
                        <input type="text" id="loginUsername" class="form-control" placeholder="用户名" required
                               autofocus>
                        <label for="loginPassword" class="sr-only">Password</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="密码" required>
                        <small style="display: none" id="msg1" class="form-text text-danger">用户名密码不正确</small>
                        <button class="btn btn-sm btn-primary btn-block" id="login_btn">登录</button>
                    </block>
                    <block id="reg_form" style="display: none">
                        <label for="regUsername" class="sr-only">Username
                            address</label>
                        <input type="text" id="regUsername" class="form-control" placeholder="用户名" required
                               autofocus>
                        <label for="regPassword" class="sr-only">Password</label>
                        <input type="password" id="regPassword" class="form-control" placeholder="密码" required>
                        <small style="display: none" id="msg4" class="form-text text-danger">用户名不能为空</small>
                        <small style="display: none" id="msg6" class="form-text text-danger">密码不能为空</small>
                        <small style="display: none" id="msg5" class="form-text text-danger">用户名已存在</small>
                        <small style="display: none" id="msg2" class="form-text text-success">注册成功</small>
                        <small style="display: none" id="msg3" class="form-text text-info">已有相同用户名注册</small>
                        <button class="btn btn-sm btn-info btn-block" id="register_btn">注册</button>
                    </block>
                </div>
            </div>
            <div class="blog-post" style="display: none" id="userinfo">
                <h1 class="h3 mb-3 font-weight-normal">账户信息</h1></a>
                <p class="blog-post-meta">当前用户 <a href="#" id="display-username">Jacob</a></p>
                <button type="button" class="btn btn-outline-secondary btn-sm btn-block">保存当前数据</button>
                <button type="button" class="btn btn-outline-secondary btn-sm btn-block">获取历史数据</button>
                <div class="table-responsive mt-3">
                    <table class="table table-sm">
                        <caption style="display: none">List of History</caption>
                        <thead class="thead-dark">
                        <tr>
                            <th scope="col">历史数据</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td><a href="#">20200423</a></td>
                        </tr>
                        <tr>
                            <td><a href="#">1221</a></td>
                        </tr>
                        <tr>
                            <td><a href="#">12321</a></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

</body>

</html>
<script src="https://cdn.bootcss.com/jquery/3.5.0/jquery.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
</script>
<script src="dist/js/echarts.js"></script>
<script src='./dist/js/ecStat.js'></script>
<script>
    function init() {
        let userinfo = getCookie('userinfo')
        console.log(userinfo)
        if (userinfo) {
            login_init(JSON.parse(userinfo))
        }
    }

    init();

    function removeSmallTxt() {
        $('#msg1').attr("style", "display:none");
        $('#msg2').attr("style", "display:none");
        $('#msg3').attr("style", "display:none");
        $('#msg4').attr("style", "display:none");
        $('#msg5').attr("style", "display:none");
        $('#msg6').attr("style", "display:none");
    }


    $("#regUsername").blur(function () {
        let username = $("#regUsername").val()
        if (username === "") {
            removeSmallTxt();
            $('#msg4').attr("style", "display:block");
        } else {
            $.ajax({
                url: "http://localhost:8080/demo/user/isExist",
                data: {
                    name: username
                },
                type: "GET",
                dataType: "json",
                ContentType: "application/json",
                success: function (res) {
                    console.log(res)
                    if (res.data) {
                        removeSmallTxt();
                        $('#msg5').attr("style", "display:block");
                    }
                }
            });
        }
    });

    $("#regPassword").blur(function () {
        let password = $("#regPassword").val()
        if (password === "") {
            removeSmallTxt();
            $('#msg6').attr("style", "display:block");
        } else {
            removeSmallTxt();
        }
    });

    function login_init(userinfo) {
        setCookie('userinfo', JSON.stringify(userinfo), 60)
        $('#login_box').attr("style", "display:none");
        $('#userinfo').attr("style", "display:block");
        $('#display-username').html(userinfo.name)
        console.log($('#display-username').html())
    }

    $("#upload").on("click", function () {
        var file = $('#file')[0].files[0];
        var formData = new FormData();
        formData.append("file", file);
        $.ajax({
            type: 'POST',
            url: "http://localhost:8080/demo/data/upload",
            cache: false,
            data: formData,
            processData: false,
            contentType: false,
            success: function (result) {
                $('#data-area').val(JSON.stringify(result.data));
            },
            error: function (err) {
            }
        });
    });

    $("#login_btn").click(function () {
        let username = $("#loginUsername").val()
        let password = $("#loginPassword").val()
        console.log(username)
        console.log(password)
        $.ajax({
            url: "http://localhost:8080/demo/user/login",
            data: {
                name: username,
                password: password
            },
            type: "GET",
            dataType: "json",
            ContentType: "application/json",
            success: function (res) {
                console.log(res)
                if (!res.data) {
                    removeSmallTxt();
                    $('#msg1').attr("style", "display:block");
                } else {
                    login_init(res.data);
                }
            }
        });
    });

    $("#register_btn").click(function () {
        let username = $("#regUsername").val()
        let password = $("#regPassword").val()
        console.log(username)
        console.log(password)
        $.ajax({
            url: "http://localhost:8080/demo/user/register",
            data: JSON.stringify({
                name: username,
                password: password
            }),
            type: "POST",
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (res) {
                console.log(res)
                if (res.data) {
                    removeSmallTxt();
                    $('#msg2').attr("style", "display:block");
                } else {
                    removeSmallTxt();
                    $('#msg3').attr("style", "display:block");
                }
            }
        });
    });

    $("#login_tab").click(function () {
        $('#login_tab').attr("class", "nav-link disabled");
        $('#reg_tab').attr("class", "nav-link active");
        $('#login_form').attr("style", "display:block");
        $('#reg_form').attr("style", "display:none");
    });

    $("#reg_tab").click(function () {
        $('#login_tab').attr("class", "nav-link active");
        $('#reg_tab').attr("class", "nav-link disabled");
        $('#login_form').attr("style", "display:none");
        $('#reg_form').attr("style", "display:block");
    });

    let data = [
        [1, 2],
        [3, 5],
        [4, 6],
        [4.5, 4]
    ];

    function chart_init(data) {
        console.log(data)
        let myChart = echarts.init(document.getElementById('main'));

        let myRegression = ecStat.regression('linear', data);
        console.log(myRegression)
        let newExp = 'F(x)= ' + myRegression.parameter.gradient + 'x' + ' + ' + myRegression.parameter.intercept
        $('#data-fx').text('结果：' + newExp);
        $('#data-area').val(JSON.stringify(data));


        myChart.setOption({
            title: {
                subtext: newExp,
                left: 'center'
            },
            toolbox: {
                feature: {
                    saveAsImage: {},
                    dataView: {}
                }
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                }
            },
            xAxis: {
                name: 'x',
                type: 'value',
                splitLine: {
                    lineStyle: {
                        type: 'dashed'
                    }
                },
            },
            yAxis: {
                name: 'F(x)',
                type: 'value',
                min: 1.5,
                splitLine: {
                    lineStyle: {
                        type: 'dashed'
                    }
                },
            },
            series: [{
                name: 'scatter',
                type: 'scatter',
                label: {
                    emphasis: {
                        show: true
                    }
                },
                data: data
            }, {
                name: 'line',
                type: 'line',
                showSymbol: true,
                data: myRegression.points,
                markPoint: {
                    itemStyle: {
                        normal: {
                            color: 'transparent'
                        }
                    },
                    // label: {
                    //     normal: {
                    //         show: true,
                    //         position: 'left',
                    //         formatter: myRegression.expression,
                    //         textStyle: {
                    //             color: '#333',
                    //             fontSize: 14
                    //         }
                    //     }
                    // },
                    data: [{
                        coord: myRegression.points[myRegression.points.length - 1]
                    }]
                }
            }]
        });
        window.onresize = function () {
            myChart.resize();
        }
    }

    chart_init(data)

    $('#linear').click(function () {
        let data = $('#data-area').val()
        if (data) {
            data = JSON.parse(data)
            console.log(data)
            chart_init(data)
        }
    })

    $('#linear-back').click(function () {
        let data = $('#data-area').val()
        if (data) {
            data = JSON.parse(data)
            console.log(data)
            $.ajax({
                url: "http://localhost:8080/demo/data/deal",
                data: JSON.stringify({
                    result: data
                }),
                type: "GET",
                dataType: "json",
                contentType: "application/json; charset=utf-8",
                success: function (res) {
                    console.log(res)
                }
            });
            chart_init(data)
        }
    })

    //写cookies
    function setCookie(cname, cvalue, exminites) {
        let d = new Date();
        d.setTime(d.getTime() + (exminites * 60 * 1000));
        let expires = "expires=" + d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    //读取cookies
    function getCookie(cname) {
        var name = cname + "=";
        var decodedCookie = decodeURIComponent(document.cookie);
        var ca = decodedCookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    //检查cookies
    function checkCookie() {
        var user = getCookie("username");
        if (user != "") {
            alert("Welcome again " + user);
        } else {
            user = prompt("Please enter your name:", "");
            if (user != "" && user != null) {
                setCookie("username", user, 365);
            }
        }
    }
</script>

<!-- http://47.93.123.132/linear/demo/user/login -->